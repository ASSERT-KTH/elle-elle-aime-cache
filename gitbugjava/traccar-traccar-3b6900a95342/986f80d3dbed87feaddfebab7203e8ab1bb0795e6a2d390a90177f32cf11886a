{
    "generation": "@Override\nprotected Object decode(\n        Channel channel, SocketAddress remoteAddress, Object msg) throws Exception {\n\n    ByteBuf buf = (ByteBuf) msg;\n\n    buf.readUnsignedByte(); // header\n    int flags = buf.readUnsignedByte();\n    buf.readUnsignedShortLE(); // length\n    buf.readUnsignedShortLE(); // checksum\n    int index = buf.readUnsignedShortLE();\n    int type = buf.readUnsignedByte();\n\n    if (BitUtil.check(flags, 4)) {\n        sendResponse(channel, remoteAddress, index, type, buf);\n    }\n\n    if (type == MSG_DATA) {\n\n        List<Position> positions = new LinkedList<>();\n        Set<Integer> keys = new HashSet<>();\n        boolean hasLocation = false;\n        Position position = new Position(getProtocolName());\n\n        DeviceSession deviceSession = null;\n\n        // Save initial reader index\n        int initialReaderIndex = buf.readerIndex();\n\n        // Find and set device session\n        while (buf.isReadable()) {\n            int endIndex = buf.readUnsignedByte() + buf.readerIndex();\n            int key = buf.readUnsignedByte();\n\n            if (key == 0x01) {\n                String deviceId = buf.readCharSequence(15, StandardCharsets.US_ASCII).toString();\n                deviceSession = getDeviceSession(channel, remoteAddress, deviceId);\n                if (deviceSession != null) {\n                    position.setDeviceId(deviceSession.getDeviceId());\n                }\n                buf.readerIndex(endIndex);\n                break;\n            } else {\n                buf.readerIndex(endIndex);\n            }\n        }\n\n        // Restore reader index to process positions\n        buf.readerIndex(initialReaderIndex);\n\n        if (deviceSession == null) {\n            return null;\n        }\n\n        while (buf.isReadable()) {\n            int endIndex = buf.readUnsignedByte() + buf.readerIndex();\n            int key = buf.readUnsignedByte();\n\n            if (keys.contains(key)) {\n                if (!hasLocation) {\n                    getLastLocation(position, null);\n                }\n                positions.add(position);\n                keys.clear();\n                hasLocation = false;\n                position = new Position(getProtocolName());\n                position.setDeviceId(deviceSession.getDeviceId()); // Ensure device ID is set for each position\n            }\n            keys.add(key);\n\n            switch (key) {\n                // Existing key handling code...\n            }\n            buf.readerIndex(endIndex);\n        }\n\n        if (!hasLocation) {\n            getLastLocation(position, null);\n        }\n        positions.add(position);\n\n        return positions;\n    }\n\n    return null;\n}",
    "exact_match": false,
    "ast_match": false,
    "compile": null,
    "test": false
}